
# Compile on MacOS

- open a terminal window and navigate to the directory containing the original FMU file

- greate a directory to extract the contents of the FMU file:

```bash
mkdir <fmu-file>
cd <fmu-file>
```

- run the following command to extract the contents of the FMU file:

```bash
unzip -o ../<fmu-file>.fmu
```

- navigate to the extracted directory

- copy the interface files directory to the extracted directory (they are available online at [FMI standard](https://fmi-standard.org/))

- make the necessary changes to the source code

### List of changes:

-  in **`lccstub.c`**, replace the following code:

```c
#include <windows.h>

BOOL  LibMain(HANDLE hModule,
                      DWORD  ul_reason_for_call,
                      LPVOID lpReserved)
{
    return TRUE;
}
```

with the following code:

```c
#include <stdbool.h>

bool LibMain(void* hModule,
             unsigned long ul_reason_for_call,
             void* lpReserved)
{
    return true;
}
````

> [!NOTE]TODO
> A cross platform implementation of the `LibMain` function should be used to ensure compatibility with different operating systems.

- Remove FMI2_FUNCTION_PREFIX definition in **`<FMU_NAME>_fmu.c`**:
> [!WARNING]
> This can cause name conflicts if the FMU is used in the same environment as other FMUs.


```c
#ifndef FMI2_FUNCTION_PREFIX
// #define FMI2_FUNCTION_PREFIX <FMU_NAME>_
#endif
```

- create a build directory:

```bash
mkdir build
cd build
```

- run the following command to compile the source code:

>[!NOTE]
They are listed in the index.html file in the `doc` directory of the FMU generated by Simulink.

```bash
gcc -I./../../fmi2 -I./../sources -c ../sources/<FMU_NAME>.c ../sources/<FMU_NAME>_data.c ../sources/rtGetInf.c ../sources/rtGetNaN.c ../sources/rt_nonfinite.c ../sources/RTWCG_FMU_util.c ../sources/<FMU_NAME>_fmu.c ../sources/lccstub.c -fPIC
```

- run the following command to create the shared library:

```bash
gcc -shared -o <FMU_NAME>.dylib <FMU_NAME>.o <FMU_NAME>_data.o rtGetInf.o rtGetNaN.o rt_nonfinite.o RTWCG_FMU_util.o <FMU_NAME>_fmu.o lccstub.o -lm
```

- copy the shared library to the binary directory:

```bash
mkdir -p ../binaries/darwin64
cp <FMU_NAME>.dylib ../binaries/darwin64
```

## Repackage the FMU

- navigate to the root directory of the FMU

```bash
cd ../
```

- run the following command to create the FMU file:

```bash
zip -r -0 ../<FMU_NAME>.fmu *
```

- the FMU file is now ready to be used in a simulation environment